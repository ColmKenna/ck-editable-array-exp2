<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events - ck-editable-array</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <a href="index.html" class="back-link">‚Üê Back to Examples</a>
      <h1>Event Handling</h1>
      <p class="subtitle">Monitor all component events with detailed event logs.</p>
    </header>

    <div class="card">
      <div class="warning-box warning-box--blue">
        <strong>Available Events:</strong>
        <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
          <li><code>datachanged</code> - Fired when data is added, modified, or deleted</li>
          <li><code>beforetogglemode</code> - Fired before entering/exiting edit mode (cancelable)</li>
          <li><code>aftertogglemode</code> - Fired after entering/exiting edit mode</li>
        </ul>
      </div>

      <div class="mb-4 flex-row gap-2 justify-end">
        <button id="addBtn" class="demo-btn">Add Task</button>
        <button id="clearLogBtn" class="demo-btn btn-neutral">Clear Log</button>
      </div>

      <ck-editable-array id="eventList">
        <template data-slot="display">
          <link rel="stylesheet" href="styles.css">
          <div class="row-item">
            <div style="width: 40px; display: flex; align-items: center;">
              <input type="checkbox" data-bind="completed" style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
            </div>
            <div class="grow">
              <div style="font-weight: 600;" data-bind="task"></div>
              <div class="text-sm text-muted">Priority: <span data-bind="priority"></span></div>
            </div>
            <div class="flex-row gap-2" style="width: auto;">
              <button data-action="toggle" class="demo-btn btn-secondary">Edit</button>
              <button data-action="delete" class="demo-btn btn-danger">Delete</button>
              <button data-action="restore" class="demo-btn btn-restore">Restore</button>
            </div>
          </div>
        </template>

        <template data-slot="edit">
          <link rel="stylesheet" href="styles.css">
          <div class="edit-panel">
            <div class="grow flex-col gap-2">
              <label>
                Task:
                <input type="text" data-bind="task" class="form-input">
              </label>
              <label>
                Priority:
                <select data-bind="priority" class="form-input">
                  <option value="Low">Low</option>
                  <option value="Medium">Medium</option>
                  <option value="High">High</option>
                </select>
              </label>
              <label class="flex-row gap-2" style="cursor: pointer;">
                <input type="checkbox" data-bind="completed">
                <span>Completed</span>
              </label>
            </div>
            <div class="flex-col gap-2">
              <button data-action="save" class="demo-btn btn-success">Save</button>
              <button data-action="cancel" class="demo-btn btn-neutral">Cancel</button>
            </div>
          </div>
        </template>
      </ck-editable-array>
    </div>

    <div class="card">
      <div class="flex-row justify-between mb-3" style="align-items: center;">
        <h2 style="margin: 0;">Event Log</h2>
        <div class="flex-row gap-2">
          <label class="flex-row gap-2" style="cursor: pointer; align-items: center;">
            <input type="checkbox" id="preventToggle">
            <span class="text-sm">Prevent edit mode</span>
          </label>
        </div>
      </div>
      <div id="eventLog" class="code-output" style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.875rem;">
        <div class="text-muted">Waiting for events...</div>
      </div>
    </div>

    <div class="card">
      <h2>Event Statistics</h2>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
        <div class="stat-card" style="text-align: center;">
          <div class="stat-accent-blue" style="font-size: 2rem; font-weight: bold;" id="dataChangedCount">0</div>
          <div class="text-sm text-muted">datachanged</div>
        </div>
        <div class="stat-card" style="text-align: center;">
          <div class="stat-accent-purple" style="font-size: 2rem; font-weight: bold;" id="beforeToggleCount">0</div>
          <div class="text-sm text-muted">beforetogglemode</div>
        </div>
        <div class="stat-card" style="text-align: center;">
          <div class="stat-accent-green" style="font-size: 2rem; font-weight: bold;" id="afterToggleCount">0</div>
          <div class="text-sm text-muted">aftertogglemode</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import '../dist/ck-editable-array/ck-editable-array.esm.js';

    const list = document.getElementById('eventList');
    const addBtn = document.getElementById('addBtn');
    const clearLogBtn = document.getElementById('clearLogBtn');
    const eventLog = document.getElementById('eventLog');
    const preventToggle = document.getElementById('preventToggle');
    const dataChangedCount = document.getElementById('dataChangedCount');
    const beforeToggleCount = document.getElementById('beforeToggleCount');
    const afterToggleCount = document.getElementById('afterToggleCount');

    let eventCounts = {
      datachanged: 0,
      beforetogglemode: 0,
      aftertogglemode: 0
    };

    // Helper to format timestamp
    function getTimestamp() {
      return new Date().toLocaleTimeString('en-US', { hour12: false, fractionalSecondDigits: 3 });
    }

    // Helper to add log entry
    function addLogEntry(eventName, detail, color = '#2563eb') {
      const entry = document.createElement('div');
      entry.style.marginBottom = '0.5rem';
      entry.style.paddingBottom = '0.5rem';
      entry.style.borderBottom = '1px solid #e5e7eb';

      const timestamp = document.createElement('span');
      timestamp.textContent = `[${getTimestamp()}] `;
      timestamp.style.color = '#6b7280';

      const name = document.createElement('span');
      name.textContent = eventName;
      name.style.color = color;
      name.style.fontWeight = 'bold';

      const detailText = document.createElement('pre');
      detailText.textContent = JSON.stringify(detail, null, 2);
      detailText.style.margin = '0.25rem 0 0 0';
      detailText.style.padding = '0.5rem';
      detailText.style.background = '#f9fafb';
      detailText.style.borderRadius = '0.25rem';
      detailText.style.fontSize = '0.8rem';

      entry.appendChild(timestamp);
      entry.appendChild(name);
      entry.appendChild(detailText);

      // Clear "waiting" message if present
      if (eventLog.children[0]?.textContent === 'Waiting for events...') {
        eventLog.innerHTML = '';
      }

      eventLog.insertBefore(entry, eventLog.firstChild);

      // Update counter
      eventCounts[eventName]++;
      updateCounters();
    }

    function updateCounters() {
      dataChangedCount.textContent = eventCounts.datachanged;
      beforeToggleCount.textContent = eventCounts.beforetogglemode;
      afterToggleCount.textContent = eventCounts.aftertogglemode;
    }

    // Initial data
    list.data = [
      { task: 'Review pull requests', priority: 'High', completed: false },
      { task: 'Update documentation', priority: 'Medium', completed: false },
      { task: 'Fix bug #123', priority: 'High', completed: true }
    ];

    // Factory for new items
    list.newItemFactory = () => ({
      task: '',
      priority: 'Medium',
      completed: false
    });

    // Handle add button
    addBtn.addEventListener('click', () => {
      list.addRow();
    });

    // Clear log
    clearLogBtn.addEventListener('click', () => {
      eventLog.innerHTML = '<div class="text-muted">Waiting for events...</div>';
      eventCounts = {
        datachanged: 0,
        beforetogglemode: 0,
        aftertogglemode: 0
      };
      updateCounters();
    });

    // Listen to datachanged event
    list.addEventListener('datachanged', (e) => {
      addLogEntry('datachanged', {
        dataLength: e.detail.data.length,
        data: e.detail.data
      }, '#2563eb');
    });

    // Listen to beforetogglemode event (cancelable)
    list.addEventListener('beforetogglemode', (e) => {
      addLogEntry('beforetogglemode', {
        index: e.detail.index,
        entering: e.detail.entering,
        cancelable: e.cancelable,
        preventingEdit: preventToggle.checked
      }, '#7c3aed');

      // Demonstrate event cancellation
      if (preventToggle.checked && e.detail.entering) {
        e.preventDefault();
        addLogEntry('EVENT CANCELLED', {
          message: 'Edit mode prevented by calling preventDefault()'
        }, '#dc2626');
      }
    });

    // Listen to aftertogglemode event
    list.addEventListener('aftertogglemode', (e) => {
      addLogEntry('aftertogglemode', {
        index: e.detail.index,
        entering: e.detail.entering
      }, '#059669');
    });

    // Log initial state
    setTimeout(() => {
      addLogEntry('datachanged', {
        dataLength: list.data.length,
        data: list.data,
        note: 'Initial data load'
      }, '#2563eb');
    }, 100);
  </script>
</body>
</html>
