<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Angular Example - ck-editable-array</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1100px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #f5f5f5;
    }

    .header {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      margin: 0 0 0.5rem 0;
      color: #2c3e50;
    }

    .subtitle {
      color: #7f8c8d;
      margin: 0;
    }

    .card {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .back-link {
      display: inline-block;
      margin-bottom: 1rem;
      color: #3498db;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    pre {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 1.5rem;
      border-radius: 4px;
      overflow-x: auto;
      line-height: 1.5;
    }

    code {
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .alert {
      background: #d1ecf1;
      border-left: 4px solid #0c5460;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
      color: #0c5460;
    }

    h2 {
      color: #2c3e50;
      border-bottom: 2px solid #ecf0f1;
      padding-bottom: 0.5rem;
      margin-top: 2rem;
    }

    h3 {
      color: #34495e;
      margin-top: 1.5rem;
    }

    ol {
      line-height: 1.8;
    }

    .step {
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body>
  <a href="ck-editable-array-help.html" class="back-link">‚Üê Back to Documentation</a>

  <div class="header">
    <h1>Angular Example</h1>
    <p class="subtitle">Using ck-editable-array in Angular applications</p>
  </div>

  <div class="card">
    <div class="alert">
      <strong>Note:</strong> This page demonstrates how to integrate the ck-editable-array component
      in Angular applications. Angular requires custom elements schema configuration.
    </div>

    <h2>Installation</h2>
    <pre><code>npm install @colmkenna/ck-webcomponents</code></pre>

    <h2>Module Configuration</h2>
    <p>Configure Angular to recognize custom elements in your module:</p>
    <pre><code>// src/app/app.module.ts
import { NgModule, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { AppComponent } from './app.component';
import { UserListComponent } from './user-list/user-list.component';

@NgModule({
  declarations: [
    AppComponent,
    UserListComponent
  ],
  imports: [
    BrowserModule
  ],
  providers: [],
  bootstrap: [AppComponent],
  schemas: [CUSTOM_ELEMENTS_SCHEMA] // Add this line
})
export class AppModule { }</code></pre>

    <h2>Import in main.ts</h2>
    <pre><code>// src/main.ts
import { platformBrowserDynamic } from '@angular/platform-browser-dynamic';
import { AppModule } from './app/app.module';

// Import the web component
import '@colmkenna/ck-webcomponents';

platformBrowserDynamic().bootstrapModule(AppModule)
  .catch(err => console.error(err));</code></pre>

    <h2>Basic Component Example</h2>
    <pre><code>// src/app/user-list/user-list.component.ts
import { Component, OnInit, ViewChild, ElementRef, AfterViewInit } from '@angular/core';

interface User {
  id: number;
  name: string;
  email: string;
  deleted?: boolean;
}

@Component({
  selector: 'app-user-list',
  templateUrl: './user-list.component.html',
  styleUrls: ['./user-list.component.css']
})
export class UserListComponent implements OnInit, AfterViewInit {
  @ViewChild('listElement', { static: false }) listElement!: ElementRef;

  users: User[] = [
    { id: 1, name: 'Alice Johnson', email: 'alice@example.com' },
    { id: 2, name: 'Bob Smith', email: 'bob@example.com' }
  ];

  ngAfterViewInit() {
    const list = this.listElement.nativeElement;

    // Set initial data
    list.data = this.users;

    // Configure new item factory
    list.newItemFactory = () => ({
      id: Date.now(),
      name: '',
      email: ''
    });

    // Listen for data changes
    list.addEventListener('datachanged', (e: any) => {
      console.log('Data changed:', e.detail.data);
      this.users = e.detail.data;
    });
  }

  ngOnInit() {
    // Component initialization
  }

  addUser() {
    const list = this.listElement.nativeElement;
    list.addRow();
  }
}</code></pre>

    <h2>Component Template</h2>
    <pre><code>&lt;!-- src/app/user-list/user-list.component.html --&gt;
&lt;div class="container"&gt;
  &lt;h1&gt;User Management&lt;/h1&gt;

  &lt;button (click)="addUser()" class="btn btn-primary"&gt;
    Add User
  &lt;/button&gt;

  &lt;ck-editable-array #listElement name="users"&gt;
    &lt;template data-slot="display"&gt;
      &lt;div class="row-display"&gt;
        &lt;div class="flex-grow"&gt;
          &lt;strong data-bind="name"&gt;&lt;/strong&gt;
          &lt;span class="text-muted ms-2" data-bind="email"&gt;&lt;/span&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;button data-action="toggle" class="btn btn-sm btn-secondary"&gt;
            Edit
          &lt;/button&gt;
          &lt;button data-action="delete" class="btn btn-sm btn-danger"&gt;
            Delete
          &lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/template&gt;

    &lt;template data-slot="edit"&gt;
      &lt;div class="edit-panel"&gt;
        &lt;div class="mb-3"&gt;
          &lt;label class="form-label"&gt;Name&lt;/label&gt;
          &lt;input type="text" data-bind="name" class="form-input"&gt;
        &lt;/div&gt;
        &lt;div class="mb-3"&gt;
          &lt;label class="form-label"&gt;Email&lt;/label&gt;
          &lt;input type="email" data-bind="email" class="form-input"&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;button data-action="cancel" class="btn btn-secondary"&gt;
            Cancel
          &lt;/button&gt;
          &lt;button data-action="save" class="btn btn-success"&gt;
            Save
          &lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  &lt;/ck-editable-array&gt;
&lt;/div&gt;</code></pre>

    <h2>With Validation Example</h2>
    <pre><code>// src/app/validated-user-list/validated-user-list.component.ts
import { Component, ViewChild, ElementRef, AfterViewInit } from '@angular/core';

interface User {
  username: string;
  email: string;
  role: string;
}

@Component({
  selector: 'app-validated-user-list',
  templateUrl: './validated-user-list.component.html',
  styleUrls: ['./validated-user-list.component.css']
})
export class ValidatedUserListComponent implements AfterViewInit {
  @ViewChild('listElement', { static: false }) listElement!: ElementRef;

  users: User[] = [
    { username: 'admin', email: 'admin@example.com', role: 'admin' }
  ];

  ngAfterViewInit() {
    const list = this.listElement.nativeElement;

    // Define validation schema
    list.validationSchema = {
      username: {
        required: true,
        minLength: 3,
        maxLength: 20,
        pattern: /^[a-zA-Z0-9_]+$/
      },
      email: {
        required: true,
        pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/
      },
      role: {
        required: true,
        custom: (value: string) => {
          return ['admin', 'editor', 'viewer'].includes(value);
        }
      }
    };

    // Configure factory
    list.newItemFactory = () => ({
      username: '',
      email: '',
      role: ''
    });

    // Set initial data
    list.data = this.users;

    // Handle data changes
    list.addEventListener('datachanged', (e: any) => {
      this.users = e.detail.data;
      console.log('Validated data:', this.users);
    });
  }

  addUser() {
    this.listElement.nativeElement.addRow();
  }
}</code></pre>

    <h2>Service Integration Example</h2>
    <pre><code>// src/app/services/user.service.ts
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';

export interface User {
  id: number;
  name: string;
  email: string;
  deleted?: boolean;
}

@Injectable({
  providedIn: 'root'
})
export class UserService {
  private apiUrl = '/api/users';

  constructor(private http: HttpClient) { }

  getUsers(): Observable&lt;User[]&gt; {
    return this.http.get&lt;User[]&gt;(this.apiUrl);
  }

  saveUsers(users: User[]): Observable&lt;any&gt; {
    return this.http.post(this.apiUrl, users);
  }
}

// Component using the service
@Component({
  selector: 'app-user-list-with-service',
  template: `
    &lt;ck-editable-array #listElement&gt;
      &lt;!-- templates --&gt;
    &lt;/ck-editable-array&gt;
  `
})
export class UserListWithServiceComponent implements OnInit, AfterViewInit {
  @ViewChild('listElement') listElement!: ElementRef;

  constructor(private userService: UserService) {}

  ngOnInit() {
    // Load data from service
    this.userService.getUsers().subscribe(users => {
      if (this.listElement) {
        this.listElement.nativeElement.data = users;
      }
    });
  }

  ngAfterViewInit() {
    const list = this.listElement.nativeElement;

    list.newItemFactory = () => ({
      id: 0,
      name: '',
      email: ''
    });

    // Save changes to server
    list.addEventListener('datachanged', (e: any) => {
      this.userService.saveUsers(e.detail.data).subscribe(
        response => console.log('Saved successfully', response),
        error => console.error('Save failed', error)
      );
    });
  }
}</code></pre>

    <h2>Reactive Forms Integration</h2>
    <p>While the component manages its own state, you can sync it with Angular's reactive forms:</p>
    <pre><code>// src/app/user-form/user-form.component.ts
import { Component, ViewChild, ElementRef, AfterViewInit } from '@angular/core';
import { FormBuilder, FormGroup } from '@angular/forms';

@Component({
  selector: 'app-user-form',
  template: `
    &lt;form [formGroup]="userForm" (ngSubmit)="onSubmit()"&gt;
      &lt;ck-editable-array #listElement&gt;
        &lt;!-- templates --&gt;
      &lt;/ck-editable-array&gt;

      &lt;button type="submit" [disabled]="!userForm.valid"&gt;
        Submit All
      &lt;/button&gt;
    &lt;/form&gt;
  `
})
export class UserFormComponent implements AfterViewInit {
  @ViewChild('listElement') listElement!: ElementRef;
  userForm: FormGroup;

  constructor(private fb: FormBuilder) {
    this.userForm = this.fb.group({
      users: [[]]
    });
  }

  ngAfterViewInit() {
    const list = this.listElement.nativeElement;

    list.newItemFactory = () => ({ name: '', email: '' });
    list.data = this.userForm.get('users')?.value || [];

    // Sync component data with form control
    list.addEventListener('datachanged', (e: any) => {
      this.userForm.patchValue({
        users: e.detail.data
      });
    });
  }

  onSubmit() {
    console.log('Form submitted:', this.userForm.value);
    // Send to server
  }
}</code></pre>

    <h2>Best Practices</h2>
    <ol>
      <li>
        <strong>Schema Configuration:</strong> Always add <code>CUSTOM_ELEMENTS_SCHEMA</code> to your module
      </li>
      <li>
        <strong>ViewChild:</strong> Use ViewChild with ElementRef to access the component
      </li>
      <li>
        <strong>AfterViewInit:</strong> Initialize component properties in <code>ngAfterViewInit</code>, not <code>ngOnInit</code>
      </li>
      <li>
        <strong>Type Safety:</strong> Define TypeScript interfaces for your data structures
      </li>
      <li>
        <strong>Service Integration:</strong> Use Angular services for HTTP requests and data management
      </li>
      <li>
        <strong>Event Handling:</strong> Use native addEventListener for custom events
      </li>
    </ol>

    <h2>Common Issues</h2>

    <h3>Property Not Found Errors</h3>
    <p>
      If TypeScript complains about properties not existing on ElementRef, cast it to <code>any</code>
      or create a type definition:
    </p>
    <pre><code>// Option 1: Cast to any
(this.listElement.nativeElement as any).data = [];

// Option 2: Create interface
interface CkEditableArrayElement extends HTMLElement {
  data: any[];
  newItemFactory: () => any;
  validationSchema: any;
  addRow(): void;
  deleteRow(index: number): void;
  restoreRow(index: number): void;
}

// Then use:
(this.listElement.nativeElement as CkEditableArrayElement).data = [];</code></pre>

    <h3>Templates Not Rendering</h3>
    <p>
      Make sure templates are defined in the HTML template file, not dynamically created in TypeScript.
      Angular needs to see them at compile time.
    </p>

    <h3>Change Detection Issues</h3>
    <p>
      If you need to manually trigger change detection after data changes:
    </p>
    <pre><code>import { ChangeDetectorRef } from '@angular/core';

constructor(private cdr: ChangeDetectorRef) {}

ngAfterViewInit() {
  list.addEventListener('datachanged', (e: any) => {
    this.users = e.detail.data;
    this.cdr.detectChanges(); // Manually trigger change detection
  });
}</code></pre>
  </div>

  <div class="card">
    <h2>Standalone Component Example (Angular 14+)</h2>
    <pre><code>// src/app/user-list/user-list.component.ts
import { Component, ViewChild, ElementRef, AfterViewInit, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-user-list',
  standalone: true,
  imports: [CommonModule],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: `
    &lt;ck-editable-array #listElement&gt;
      &lt;!-- templates --&gt;
    &lt;/ck-editable-array&gt;
  `
})
export class UserListComponent implements AfterViewInit {
  @ViewChild('listElement') listElement!: ElementRef;

  ngAfterViewInit() {
    const list = this.listElement.nativeElement;
    list.data = [];
    list.newItemFactory = () => ({ name: '', email: '' });
  }
}</code></pre>
  </div>
</body>
</html>